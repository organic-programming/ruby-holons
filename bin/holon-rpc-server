#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SDK_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"
GO_HOLONS_DIR="${SDK_DIR}/../go-holons"
HELPER_PATH="${SDK_DIR}/../kotlin-holons/cmd/holon-rpc-server-go/main.go"
PREFERRED_GO_BIN="/Users/bpds/go/go1.25.1/bin/go"

resolve_go_bin() {
  if [[ -n "${GO_BIN:-}" ]]; then
    printf '%s\n' "${GO_BIN}"
    return
  fi
  if [[ -x "${PREFERRED_GO_BIN}" ]]; then
    printf '%s\n' "${PREFERRED_GO_BIN}"
    return
  fi
  printf '%s\n' "go"
}

contains_flag() {
  local flag_name="$1"
  shift
  local arg
  for arg in "$@"; do
    if [[ "${arg}" == "${flag_name}" || "${arg}" == "${flag_name}="* ]]; then
      return 0
    fi
  done
  return 1
}

normalize_uri_position() {
  local args=("$@")
  if [[ ${#args[@]} -lt 2 ]]; then
    printf '%s\0' "${args[@]}"
    return
  fi

  local first="${args[0]}"
  if [[ "${first}" != ws://* && "${first}" != wss://* ]]; then
    printf '%s\0' "${args[@]}"
    return
  fi

  local seen_flag=false
  local arg
  for arg in "${args[@]:1}"; do
    if [[ "${arg}" == --* ]]; then
      seen_flag=true
      break
    fi
  done

  if [[ "${seen_flag}" == true ]]; then
    args=("${args[@]:1}" "${first}")
  fi

  printf '%s\0' "${args[@]}"
}

GO_CMD="$(resolve_go_bin)"
export GOCACHE="${GOCACHE:-/tmp/go-cache-ruby-cert}"

args=("$@")
if [[ ${#args[@]} -gt 0 ]]; then
  normalized=()
  while IFS= read -r -d '' arg; do
    normalized+=("$arg")
  done < <(normalize_uri_position "${args[@]}")
  args=("${normalized[@]}")
fi
if [[ ${#args[@]} -eq 0 ]]; then
  args=("--sdk" "ruby-holons")
elif ! contains_flag "--sdk" "${args[@]}"; then
  args=("--sdk" "ruby-holons" "${args[@]}")
fi

cd "${GO_HOLONS_DIR}"
exec "${GO_CMD}" run "${HELPER_PATH}" "${args[@]}"
